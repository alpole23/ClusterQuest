params {
    // ╔═══════════════════════════════════════════════════════════════════════════╗
    // ║                         PIPELINE CONFIGURATION                            ║
    // ╠═══════════════════════════════════════════════════════════════════════════╣
    // ║  Workflow Structure:                                                      ║
    // ║                                                                           ║
    // ║  ┌─────────────────┐                                                      ║
    // ║  │ DOWNLOAD_GENOMES│ ─► Download & prepare genomes from NCBI              ║
    // ║  └────────┬────────┘                                                      ║
    // ║           │                                                               ║
    // ║           ▼                                                               ║
    // ║  ┌─────────────────┐                                                      ║
    // ║  │  BGC_ANALYSIS   │ ─► Main analysis workflow                            ║
    // ║  │  ┌─────────────┐│                                                      ║
    // ║  │  │ ANTISMASH   ││ ─► BGC detection (with optional reuse)               ║
    // ║  │  └─────────────┘│                                                      ║
    // ║  │  ┌─────────────┐│                                                      ║
    // ║  │  │ CLUSTERING  ││ ─► BiG-SCAPE / BiG-SLiCE GCF clustering              ║
    // ║  │  └─────────────┘│                                                      ║
    // ║  │  ┌─────────────┐│                                                      ║
    // ║  │  │ PHYLOGENY   ││ ─► GTDB-Tk phylogenetic placement (with reuse)       ║
    // ║  │  └─────────────┘│                                                      ║
    // ║  │  ┌─────────────┐│                                                      ║
    // ║  │  │ VISUALIZE   ││ ─► Interactive HTML report generation                ║
    // ║  │  └─────────────┘│                                                      ║
    // ║  └─────────────────┘                                                      ║
    // ╚═══════════════════════════════════════════════════════════════════════════╝

    // ┌───────────────────────────────────────────────────────────────────────────┐
    // │ GLOBAL                                                                    │
    // │ General settings that apply to the entire pipeline                        │
    // └───────────────────────────────────────────────────────────────────────────┘

    workflow = "full"       // Pipeline mode: "download", "bgc_analysis", or "full"
    outdir   = "results"    // Output directory for all results

    // ┌───────────────────────────────────────────────────────────────────────────┐
    // │ DOWNLOAD_GENOMES                                                          │
    // │ Download and prepare bacterial genomes from NCBI                          │
    // │ Used by: --workflow download, --workflow full                             │
    // └───────────────────────────────────────────────────────────────────────────┘

    taxon = "Pantoea ananatis"  // NCBI taxon (species, genus, family, order, etc.)

    // ┌───────────────────────────────────────────────────────────────────────────┐
    // │ ANTISMASH_ANALYSIS                                                        │
    // │ BGC detection using antiSMASH                                             │
    // │ Used by: --workflow bgc_analysis, --workflow full                         │
    // └───────────────────────────────────────────────────────────────────────────┘

    // Input source (only for --workflow bgc_analysis)
    input_genomes = "null"      // Path to pre-downloaded genomes directory

    // Cross-taxon result reuse
    // Example: Run on "Pantoea" while reusing results from previous "Erwiniaceae" run
    reuse_antismash_from = null // Taxon name to reuse antiSMASH results from

    // Core settings
    antismash_minimal  = false  // Minimal mode (faster, skips domain analysis)
    hmmdetection_rules = ""     // Limit detection to specific types (e.g., "terpene,nrps")

    // Additional analyses (only when antismash_minimal = false)
    antismash_cb_knownclusters = true   // KnownClusterBlast: Compare vs MIBiG
    antismash_cb_general       = false  // ClusterBlast: Compare vs antiSMASH DB
    antismash_cc_mibig         = false  // ClusterCompare: Advanced MIBiG scoring
    antismash_smcog_trees      = false  // Phylogenetic trees for BGC genes
    // Note: clusterhmmer and tigrfam are always enabled for consistent domain analysis

    // ┌───────────────────────────────────────────────────────────────────────────┐
    // │ REGION ANALYSIS                                                           │
    // │ BGC counting, tabulation, and statistics                                  │
    // │ Used by: --workflow bgc_analysis, --workflow full                         │
    // └───────────────────────────────────────────────────────────────────────────┘

    run_analysis     = true     // Enable region analysis and visualization
    count_per_contig = false    // Count per contig (true) or per genome (false)
    split_hybrids    = false    // Split hybrid types (T1PKS-NRPS → T1PKS + NRPS)

    // ┌───────────────────────────────────────────────────────────────────────────┐
    // │ CLUSTERING                                                                │
    // │ Gene Cluster Family (GCF) clustering with BiG-SCAPE and/or BiG-SLiCE      │
    // │ Used by: --workflow bgc_analysis, --workflow full                         │
    // └───────────────────────────────────────────────────────────────────────────┘

    clustering = "bigscape"     // "none", "bigscape", "bigslice", or "both"

    // ─── BiG-SCAPE Options ───────────────────────────────────────────────────────
    // Network-based clustering using sequence similarity
    // Active when: clustering = "bigscape" or "both"

    bigscape_cutoffs           = "0.30"     // GCF distance threshold(s), comma-separated
    bigscape_alignment_mode    = "auto"     // "auto", "global", or "glocal"
    bigscape_mibig_version     = ""         // MIBiG version (e.g., "3.1") or "" to exclude
    bigscape_classify          = "category" // "", "category", "class", or "legacy"
    bigscape_include_singletons = true      // Include unclustered BGCs
    bigscape_mix               = false      // Allow mixing BGC classes in same GCF

    // ─── BiG-SLiCE Options ───────────────────────────────────────────────────────
    // Feature-based clustering using machine learning models
    // Active when: clustering = "bigslice" or "both"

    bigslice_threshold  = "100"     // Distance threshold (lower = stricter)
    bigslice_query_mode = false     // Query mode vs clustering mode
    bigslice_query_db   = ""        // Path to existing database (for query mode)

    // ┌───────────────────────────────────────────────────────────────────────────┐
    // │ PHYLOGENY                                                                 │
    // │ Phylogenetic placement using GTDB-Tk                                      │
    // │ Used by: --workflow bgc_analysis, --workflow full                         │
    // │ ⚠️  Requires ~140 GB disk space and ~56-64 GB RAM                         │
    // └───────────────────────────────────────────────────────────────────────────┘

    run_gtdbtk = true               // Enable phylogenetic analysis

    // Cross-taxon result reuse (same as antiSMASH reuse)
    reuse_gtdbtk_from = null        // Taxon name to reuse GTDB-Tk results from

    // Analysis scope
    gtdbtk_bgc_genomes_only = true  // Only analyze genomes with detected BGCs

    // Resource allocation
    gtdbtk_cpus         = 8         // CPUs for identify/align steps
    gtdbtk_pplacer_cpus = 1         // CPUs for pplacer (keep low, memory-bound)

    // Quality filtering
    gtdbtk_min_perc_aa = 10         // Minimum % amino acids in MSA

    // Tree output
    gtdbtk_outgroup = null          // Outgroup pattern for tree rooting (e.g., "g__Escherichia")
}

// =============================================================================
// CONFIGURATION PROFILES
// =============================================================================
// Use profiles with: nextflow run main.nf -profile <profile_name>

profiles {
    // Local execution profile - reduced memory for workstations
    local {
        executor.name = 'local'

        process {
            // Override high memory requirement for local execution
            // GTDB-Tk can run with less RAM but will be slower
            withLabel: 'process_high_memory' {
                memory = '48 GB'
            }

            // Reduce other high-memory processes for local
            withLabel: 'process_high' {
                memory = '16 GB'
            }
        }
    }

    // SLURM cluster profile - optimized based on benchmark (1,476 Pantoea genomes)
    // Uses labels from conf/labels.config with SLURM-specific overrides
    slurm {
        executor {
            name = 'slurm'
            queueSize = 200           // Max concurrent jobs
            submitRateLimit = '20/1min'
        }

        process {
            executor = 'slurm'
            queue = 'normal'

            // SLURM-specific overrides for labeled processes
            // These augment the defaults from conf/labels.config

            // High memory processes go to special queue with full RAM
            withLabel: 'process_high_memory' {
                queue = 'highmem'
                memory = '128 GB'
            }

            // BiG-SCAPE needs more memory on cluster (scales O(n^2))
            withName: 'BIGSCAPE' {
                memory = '64 GB'
            }

            // Visualization needs more memory for large trees
            withName: 'VISUALIZE_RESULTS' {
                memory = '16 GB'
                time = '4h'
            }

            // Database downloads need longer time
            withName: 'DOWNLOAD_GTDBTK_DB' {
                time = '12h'
            }

            // Network-bound processes
            withName: 'NCBI_DATASETS_DOWNLOAD' {
                time = '4h'
            }
        }

        // Conda settings for cluster
        conda.enabled = true
    }
}

// Essential nextflow run parameters, do not modify
ansiLog = true
conda {
    enabled = true
    channels = ['conda-forge', 'bioconda', 'defaults']
}

// Include centralized configuration files
includeConfig 'conf/conda.config'
includeConfig 'conf/labels.config'

// Resource tracking - generates trace file for memory/CPU analysis
trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_trace.tsv"
    fields = 'task_id,hash,name,status,exit,submit,start,complete,realtime,cpus,memory,peak_rss,peak_vmem,%cpu,%mem,rchar,wchar'
    overwrite = true
}

// Pipeline execution reports
report {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_timeline.html"
    overwrite = true
}
